name: ä¸‹è½½-PUTä¸Šä¼ -åˆ é™¤ æµæ°´çº¿ï¼ˆcurl -T æ ¼å¼ï¼‰
on:
  workflow_dispatch:
    inputs:
      download_url:
        description: 'éœ€è¦ä¸‹è½½çš„URLï¼ˆå¤šä¸ªURLç”¨é€—å·åˆ†éš”ï¼‰'
        required: true
        default: 'https://example.com/file1.txt,https://example.com/file2.zip'
      download_dir:
        description: 'ä¸´æ—¶ä¸‹è½½ç›®å½•ï¼ˆå•æ–‡ä»¶å­˜å‚¨ï¼Œé¿å…ç´¯ç§¯ï¼‰'
        required: false
        default: './temp_download'
      upload_base_url:
        description: 'ä¸Šä¼ åŸºç¡€URLï¼ˆå¯¹åº”ç¤ºä¾‹ä¸­çš„ http://127.0.0.1:5000/new-path/ï¼‰'
        required: true
        default: 'https://dufs.wangjiahui.org:9443/ComfyUI/'
      retention_days:
        description: 'äº§ç‰©ä¿ç•™å¤©æ•°ï¼ˆä»…æ—¥å¿—ï¼Œæ— æ–‡ä»¶äº§ç‰©ï¼‰'
        required: false
        default: 1

jobs:
  download-put-upload-delete:
    runs-on: ubuntu-latest
    steps:
      # å¯é€‰ï¼šæ£€å‡ºä»“åº“ï¼ˆæ— éœ€å…³è”ä»“åº“æ–‡ä»¶å¯åˆ é™¤ï¼‰
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # æ­¥éª¤1ï¼šåˆå§‹åŒ–ä¸´æ—¶ç›®å½•ï¼ˆç¡®ä¿å¹²å‡€æ— æ®‹ç•™ï¼‰
      - name: åˆ›å»ºå¹¶æ¸…ç©ºä¸´æ—¶ç›®å½•
        run: |
          rm -rf ${{ github.event.inputs.download_dir }}
          mkdir -p ${{ github.event.inputs.download_dir }}
          chmod 755 ${{ github.event.inputs.download_dir }}

      # æ­¥éª¤2ï¼šå®‰è£…ä¾èµ–ï¼ˆwget + curlï¼‰
      - name: å®‰è£…wgetå’Œcurl
        run: |
          sudo apt update && sudo apt install -y wget curl

      # æ­¥éª¤3ï¼šæ ¸å¿ƒæµæ°´çº¿ï¼šä¸‹è½½â†’PUTä¸Šä¼ â†’åˆ é™¤ï¼ˆå•æ–‡ä»¶åŸå­åŒ–ï¼‰
      - name: ä¸‹è½½-PUTä¸Šä¼ -åˆ é™¤ å¾ªç¯æ‰§è¡Œ
        run: |
          # æ‹†åˆ†URLåˆ—è¡¨å¹¶åˆå§‹åŒ–å˜é‡
          IFS=',' read -ra URL_LIST <<< "${{ github.event.inputs.download_url }}"
          UPLOAD_BASE="${{ github.event.inputs.upload_base_url }}"
          TEMP_DIR="${{ github.event.inputs.download_dir }}"

          # éå†æ¯ä¸ªURLæ‰§è¡Œæµæ°´çº¿
          for url in "${URL_LIST[@]}"; do
            url_trimmed=$(echo "$url" | xargs)
            if [ -z "$url_trimmed" ]; then
              echo "âš ï¸ è·³è¿‡ç©ºURL"
              continue
            fi

            echo "====================================="
            echo "å¼€å§‹å¤„ç†URL: $url_trimmed"
            echo "====================================="

            # --------------------------
            # å­æ­¥éª¤1ï¼šä¸‹è½½æ–‡ä»¶ï¼ˆä¿ç•™åŸå§‹æ–‡ä»¶åï¼‰
            # --------------------------
            echo "ğŸ“¥ å¼€å§‹ä¸‹è½½æ–‡ä»¶..."
            # å…ˆè·å–åŸå§‹æ–‡ä»¶åï¼ˆé¿å…ä¸´æ—¶æ–‡ä»¶å‘½åä¸¢å¤±ï¼‰
            original_filename=$(basename "$(wget --server-response --spider --content-disposition "$url_trimmed" 2>&1 | grep -oP 'filename="\K[^"]+' || basename "$url_trimmed")")
            original_filename=$(echo "$original_filename" | xargs)  # æ¸…ç†ç©ºæ ¼
            local_file_path="$TEMP_DIR/$original_filename"  # ä¸´æ—¶æ–‡ä»¶è·¯å¾„ï¼ˆå¸¦åŸå§‹æ–‡ä»¶åï¼‰

            # ä¸‹è½½æ–‡ä»¶åˆ°ä¸´æ—¶è·¯å¾„ï¼ˆå¼ºåˆ¶ä¿ç•™åŸå§‹æ–‡ä»¶åï¼‰
            wget -O "$local_file_path" \
                 -c -T 60 -nv \
                 --no-check-certificate \
                 "$url_trimmed"
            
            # æ£€æŸ¥ä¸‹è½½ç»“æœ
            if [ $? -ne 0 ] || [ ! -f "$local_file_path" ]; then
              echo "âŒ ä¸‹è½½å¤±è´¥: $url_trimmed"
              rm -f "$local_file_path"  # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
              exit 1
            fi
            echo "âœ… ä¸‹è½½æˆåŠŸï¼ŒåŸå§‹æ–‡ä»¶å: $original_filenameï¼Œä¸´æ—¶è·¯å¾„: $local_file_path"

            # --------------------------
            # å­æ­¥éª¤2ï¼šPUTä¸Šä¼ ï¼ˆä¸¥æ ¼åŒ¹é… curl -T æ ¼å¼ï¼‰
            # æ ¼å¼ï¼šcurl -T æœ¬åœ°æ–‡ä»¶è·¯å¾„ ä¸Šä¼ ç›®æ ‡URLï¼ˆåŸºç¡€URL+åŸå§‹æ–‡ä»¶åï¼‰
            # ç¤ºä¾‹ï¼šcurl -T ./temp/file.txt https://dufs.wangjiahui.org:9443/ComfyUI/file.txt
            # --------------------------
            echo "ğŸ“¤ å¼€å§‹PUTä¸Šä¼ ï¼ˆcurl -T æ ¼å¼ï¼‰..."
            upload_target_url="$UPLOAD_BASE$original_filename"  # æ‹¼æ¥æœ€ç»ˆä¸Šä¼ URL
            echo "ä¸Šä¼ å‘½ä»¤ï¼šcurl -T $local_file_path $upload_target_url"

            # curl PUT æ ¸å¿ƒå‚æ•°ï¼š
            # -Tï¼šPUTä¸Šä¼ ï¼ˆæŒ‡å®šæœ¬åœ°æ–‡ä»¶ï¼‰
            # -kï¼šå¿½ç•¥è‡ªç­¾åSSLè¯ä¹¦é”™è¯¯ï¼ˆä½ çš„ç›®æ ‡åœ°å€æ˜¯HTTPSï¼‰
            # -Lï¼šè·Ÿéšé‡å®šå‘
            # -w "%{http_code}"ï¼šè¾“å‡ºHTTPçŠ¶æ€ç ï¼ˆç”¨äºåˆ¤æ–­æˆåŠŸï¼‰
            # -o /dev/nullï¼šé™é»˜è¾“å‡ºï¼ˆä»…ä¿ç•™çŠ¶æ€ç ï¼‰
            # --connect-timeout 30ï¼šè¿æ¥è¶…æ—¶30ç§’
            # --max-time 300ï¼šä¸Šä¼ è¶…æ—¶5åˆ†é’Ÿ
            upload_http_code=$(curl -T "$local_file_path" \
                                    "$upload_target_url" \
                                    -k -L \
                                    --connect-timeout 30 \
                                    --max-time 300 \
                                    -w "%{http_code}" \
                                    -o /dev/null)

            # æ£€æŸ¥ä¸Šä¼ ç»“æœï¼ˆ200/201/204 ä¸ºå¸¸è§æˆåŠŸçŠ¶æ€ç ï¼Œå¯æ ¹æ®ç›®æ ‡æœåŠ¡è°ƒæ•´ï¼‰
            if [[ "$upload_http_code" =~ ^20[0-4]$ ]]; then
              echo "âœ… PUTä¸Šä¼ æˆåŠŸï¼ŒHTTPçŠ¶æ€ç : $upload_http_code"
            else
              echo "âŒ PUTä¸Šä¼ å¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : $upload_http_code"
              rm -f "$local_file_path"  # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
              exit 1
            fi

            # --------------------------
            # å­æ­¥éª¤3ï¼šåˆ é™¤ä¸´æ—¶æ–‡ä»¶ï¼ˆå…³é”®ï¼šé‡Šæ”¾ç£ç›˜ç©ºé—´ï¼‰
            # --------------------------
            echo "ğŸ—‘ï¸ å¼€å§‹åˆ é™¤ä¸´æ—¶æ–‡ä»¶..."
            rm -f "$local_file_path"
            if [ -f "$local_file_path" ]; then
              echo "âš ï¸ ä¸´æ—¶æ–‡ä»¶åˆ é™¤å¤±è´¥: $local_file_path"
              exit 1
            else
              echo "âœ… ä¸´æ—¶æ–‡ä»¶å·²æˆåŠŸåˆ é™¤ï¼Œç£ç›˜ç©ºé—´é‡Šæ”¾å®Œæˆ"
            fi

            echo "====================================="
            echo "URLå¤„ç†å®Œæˆ: $url_trimmed"
            echo "====================================="
            echo ""
          done

      # æ­¥éª¤4ï¼šæœ€ç»ˆæ¸…ç†ä¸´æ—¶ç›®å½•ï¼ˆå…œåº•ï¼Œç¡®ä¿æ— æ®‹ç•™ï¼‰
      - name: æœ€ç»ˆæ¸…ç†ä¸´æ—¶ç›®å½•
        if: always()
        run: |
          rm -rf ${{ github.event.inputs.download_dir }}
          echo "âœ… ä¸´æ—¶ç›®å½•å·²å½»åº•æ¸…ç†"
